import 'package:hackernews_flutter/src/json_parsing.dart';
import 'package:test/test.dart';
import 'package:http/http.dart' as http;

main() {
  test("parses topstories.json", () {
    const jsonString =
        """[22987747,22988584,22987219,22986965,22989950,22989927,22989904,22986380,22990014,22988625,22985342,22984993,22985055,22983155,22987242,22986147,22985072,22989501,22986003,22986134,22969737,22985261,22989041,22984628,22984604,22983744,22984508,22975636,22970975,22955328,22987707,22986828,22984639,22977448,22970653,22967883,22989014,22988323,22979245,22980932,22980676,22985719,22980003,22983691,22972983,22983274,22986630,22976611,22990062,22979288,22974134,22977845,22988078,22981634,22986826,22984659,22982247,22988605,22978480,22982731,22983751,22960225,22976433,22975437,22985802,22983115,22988242,22986221,22989368,22970771,22979067,22978454,22976084,22958477,22983894,22982592,22988168,22977637,22977966,22978673,22974593,22954765,22988330,22988752,22978608,22977690,22967701,22972730,22988460,22977077,22977076,22975104,22969533,22978509,22978103,22987187,22975656,22981491,22988052,22983043,22988569,22983660,22966411,22970120,22980869,22978350,22976643,22965078,22975227,22959023,22980921,22981884,22981967,22981945,22956182,22987417,22976586,22974380,22972661,22948443,22963822,22973455,22981616,22980410,22976204,22988809,22971656,22983678,22970693,22976626,22942278,22986922,22964211,22980467,22987793,22979400,22982982,22966043,22978950,22976379,22936818,22981252,22980871,22974920,22984179,22965049,22982051,22974853,22984116,22982289,22982553,22977327,22978147,22982272,22971863,22967255,22982482,22957383,22987054,22980406,22964031,22940564,22945942,22964708,22970602,22956318,22964696,22965767,22968079,22978248,22964259,22969477,22959897,22981740,22962547,22964910,22961054,22956832,22943749,22974585,22986290,22963232,22974976,22969571,22959013,22978842,22947424,22964441,22966332,22974957,22975299,22977274,22971154,22971691,22955842,22956776,22963226,22963765,22975225,22964972,22979374,22962830,22976846,22976318,22959587,22955606,22966167,22956392,22956948,22943620,22968280,22976502,22976437,22950848,22961666,22975413,22953401,22948885,22941224,22978550,22982243,22982229,22978354,22970834,22982541,22984878,22973011,22972486,22969984,22960199,22956369,22957573,22958675,22951790,22961296,22965187,22975776,22953316,22944690,22955607,22971308,22962609,22953730,22968839,22938901,22968039,22980015,22949604,22958870,22967716,22958352,22959238,22979838,22957884,22947447,22945630,22940908,22974090,22936742,22962663,22944193,22972645,22943536,22971952,22974728,22954366,22944891,22943126,22959351,22981555,22939068,22955076,22968743,22982365,22968808,22977016,22952070,22955419,22969987,22963649,22963611,22944194,22941204,22963495,22984029,22972658,22954656,22947968,22946710,22956562,22955971,22953176,22977911,22967559,22982691,22951281,22938790,22968803,22945725,22978814,22977497,22951312,22941884,22948687,22977291,22943427,22975238,22943075,22941231,22941215,22955779,22953891,22941144,22951986,22956951,22939207,22953484,22957091,22942461,22948723,22963478,22954815,22985774,22947341,22955085,22938604,22962574,22977018,22974313,22955394,22961304,22937076,22953506,22946014,22967717,22941489,22945072,22973891,22957920,22943601,22945353,22971861,22979110,22957517,22962869,22953320,22944314,22952085,22941185,22973955,22955260,22941223,22940246,22952131,22977383,22938736,22940211,22955488,22939248,22937851,22955611,22943001,22943983,22957988,22949225,22968796,22942027,22944684,22975002,22939044,22949965,22963609,22940416,22972820,22941247,22955420,22940394,22944382,22953622,22948451,22986226,22957609,22983877,22982195,22957968,22941733,22967876,22944490,22945741,22957327,22982086,22937202,22946824,22948499,22980852,22947395,22952572,22965077,22974711,22948055,22954068,22961916,22959646,22943990,22977365,22989280,22945907,22974164,22940450,22936811,22978153,22979464,22941206,22981417,22941190,22978173,22981076,22957295,22946949,22961902,22968081,22977718,22979929,22940735,22980734,22967492,22966768,22947892,22955269,22949615,22945065,22982667,22950495,22954382,22972750,22982443,22939686,22963001,22982336,22949312,22981658,22944837,22946092,22977023,22956870,22940360,22945360,22970043,22944903,22945142,22957994,22955283,22981845,22950236,22955068,22950915,22941995,22968963,22946832,22945690,22952573,22964500,22940265,22976097,22948388,22981393,22968066,22968030,22975330,22938152,22946674,22963687,22944806,22946084,22957082,22975906,22972709,22975017,22952871,22980569,22941233,22981834,22957677,22977750,22961497,22937049,22977922,22958161,22986883,22951762,22959919,22940947,22965421,22955350,22942752,22958535,22950009,22951210,22979432,22944769]""";

    expect(parseTopStories(jsonString).first, 22987747);
  });

  test("parses item.json", () {
    const jsonString =
        """{"by":"dhouston","descendants":71,"id":8863,"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}""";

    expect(parseArticle(jsonString).by, "dhouston");
  });

  test("parse item.json over a network", () async {
    final url = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final res = await http.get(url);
    if (res.statusCode == 200) {
      final idList = parseTopStories(res.body);
      if (idList.isNotEmpty) {
        final storyUrl =
            'https://hacker-news.firebaseio.com/v0/item/${idList.first}.json';
        final storyRes = await http.get(storyUrl);
        if (storyRes.statusCode == 200) {
          final article = parseArticle(storyRes.body);

          expect(article.by, "dhouston");
        }
      }
    }
  });
}
